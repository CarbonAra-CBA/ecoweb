{% extends "common.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container-fluid">
    <!-- ìš”ì†Œ ê°œìˆ˜ ì°¨íŠ¸ì™€ Lighthouse ë¶„ì„ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">ì´ë¯¸ì§€ ìœ í˜•ë³„ ë¶„í¬</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position:relative;">
                        <canvas id="fileChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">ì´ë¯¸ì§€ ìµœì í™” ë¶„ì„</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead class="thead-light">
                            <tr>
                                <th>ë¶„ì„ í•­ëª©</th>
                                <th>ìš©ëŸ‰</th>
                                <th>ìƒì„¸ ë‚´ìš©</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ì´ ë¦¬ì†ŒìŠ¤ ìš©ëŸ‰</td>
                                <td>{{ (view_data.total_byte_weight / 1024 / 1024)|round(2) }}MB</td>
                                <td>ì „ì²´ í˜ì´ì§€ ë¦¬ì†ŒìŠ¤ í¬ê¸°</td>
                            </tr>
                            {% if view_data.modern_image_formats_bytes > 0 %}
                            <tr>
                                <td>ì´ë¯¸ì§€ ìµœì í™” ê°€ëŠ¥</td>
                                <td>{{ (view_data.modern_image_formats_bytes / 1024)|round(2) }}KB</td>
                                <td>WebP/AVIF í¬ë§· ë³€í™˜ìœ¼ë¡œ ì ˆê° ê°€ëŠ¥</td>
                            </tr>
                            {% endif %}
                            {% if view_data.efficient_animated_content > 0 %}
                            <tr>
                                <td>ì• ë‹ˆë©”ì´ì…˜ ìµœì í™”</td>
                                <td>{{ (view_data.efficient_animated_content / 1024)|round(2) }}KB</td>
                                <td>GIFë¥¼ MP4/WebMìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì ˆê° ê°€ëŠ¥</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ê°œì„  ì œì•ˆì‚¬í•­ì„ Lighthouse ë¶„ì„ ì•„ë˜ì— ë°°ì¹˜ -->
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-body p-4">
                    <h4 class="text-muted mb-3">ê°œì„  ì œì•ˆì‚¬í•­</h4>
                    <div class="improvement-items">
                        <div class="improvement-item d-flex align-items-center p-3 bg-light rounded-3 mb-3">
                            <div class="improvement-icon me-3">ğŸ’¡</div>
                            <div>
                                <h6 class="mb-1">ì´ë¯¸ì§€ ìµœì í™”</h6>
                                <p class="mb-0 text-muted small">í˜„ì¬ ì´ë¯¸ì§€ í¬ê¸°: 2.3MB â†’ ìµœì í™” í›„: 0.5MB</p>
                                <p class="text-success mb-0 small">ì˜ˆìƒ ê°ì†ŒëŸ‰: 0.05g COâ‚‚/ë°©ë¬¸</p>
                            </div>
                        </div>
                        <!-- ì¶”ê°€ ì œì•ˆì‚¬í•­ í…œí”Œë¦¿ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ë¹„êµ ì„¹ì…˜ -->
    <div class="row mb-4">
        <!-- í˜•ì‹ë³€í™˜ ê¶Œì¥ ì´ë¯¸ì§€ ëª©ë¡ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        í˜•ì‹ë³€í™˜ ê¶Œì¥ ì´ë¯¸ì§€ ëª©ë¡ 
                        <i class="fa-regular fa-folder"></i>
                        <span class="text-muted fs-6">(ì´ {{ totalsize }} bytes, {{ filecount }}ê°œ)</span>
                    </h5>

                    <div>
                        <button class="btn btn-success btn-sm" onclick="downloadImageList()">
                            <i class="fas fa-download me-1"></i>í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ(.txt)
                        </button>
                    </div>


                </div>
                <div class="card-body">
                    <div class="row">
                        {% for file in files[:6] %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <canvas class="img-preview mb-3" width="200" height="200" 
                                            data-src="{{ url_for('static', filename='images/' + url_s + '/' + file.name) }}"></canvas>
                                    <h6 class="card-title text-truncate">{{ file.name }}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">í¬ê¸°: {{ file.size }} bytes</small><br>
                                        {% if "ico" in file.name %}
                                        <span class="badge bg-success">ì•„ì´ì½˜</span>
                                        {% elif "logo" in file.name %}
                                        <span class="badge bg-primary">ë¡œê³ </span>
                                        {% else %}
                                        <span class="badge bg-secondary">ê¸°íƒ€</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if files|length > 6 %}
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMore('original')">ë”ë³´ê¸°</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ë³€í™˜ëœ Webp íŒŒì¼ ëª©ë¡ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        ë³€í™˜ëœ Webp íŒŒì¼ ëª©ë¡
                        <span class="text-muted fs-6">(ìµœì í™” í›„)</span>
                    </h5>
                    <button class="btn btn-primary btn-sm" onclick="downloadWebpFiles()">
                        <i class="fas fa-download me-1"></i>Webp íŒŒì¼ ë‹¤ìš´ë¡œë“œ(.zip)
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% set displayed_count = namespace(value=0) %}
                        {% for category_name, files in category.items() %}
                        {% for file in convertedfiles[:6] %}
                        {% if displayed_count.value < 6 %}

                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <canvas class="img-preview mb-3" width="100" height="100" 
                                            data-src="{{ url_for('static', filename='images/' + url_s + '/img_to_webp/' + file.name) }}"></canvas>
                                    <h6 class="card-title text-truncate">{{ file.name }}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">í¬ê¸°: {{ file.size }} bytes</small>
                                        <br>
                                        {% if file.size and file.get('original_size', 0) > 0 %}
                                        <small class="text-success">
                                            ì ˆê°: {{ ((file.get('original_size', 0) - file.size) / file.get('original_size', 1) * 100)|round(1) }}%
                                        </small>
                                        {% endif %}
                                    </p>
                                    <div class="text-end">
                                        <button class="btn btn-outline-success btn-sm" onclick="downloadSingleWebp('{{ url_s }}', '{{ file.name }}')">
                                            <i class="fas fa-download me-1"></i>Webp
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% set displayed_count.value = displayed_count.value + 1 %}
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                    </div>
                    {% if convertedfiles|length > 6 %}
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadMore('webp')">ë”ë³´ê¸°</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // ê¸°ì¡´ ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€
    const files = {{ category | tojson }};
    const iconsData = files.iconfile.map(file => file.size);
    const logosData = files.logofile.map(file => file.size);
    const othersData = files.others.map(file => file.size);

    const ctx = document.getElementById('fileChart').getContext('2d');
    const fileChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: Math.max(iconsData.length, logosData.length, othersData.length)}, (_, i) => i + 1),
            datasets: [
                {
                    label: 'Icons',
                    data: iconsData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    fill: false,
                },
                {
                    label: 'Logos',
                    data: logosData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    fill: false,
                },
                {
                    label: 'Others',
                    data: othersData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: false,
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'File Size (bytes)'
                    }
                }
            }
        }
    });

    // ë”ë³´ê¸° ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸
    const url_s = "{{ url_s }}";
    const totalsize = "{{ totalsize }}";
    const fileList = {{ files | tojson | safe }};
    const categoryFiles = {{ category | tojson | safe }};
    let currentOriginalIndex = 6;  // ì´ˆê¸° í‘œì‹œë˜ëŠ” ê°œìˆ˜
    let currentWebpIndex = 6;
    const increment = 8;

     // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ í•¨ìˆ˜
     function loadImagePreviews() {
        const canvases = document.querySelectorAll('.img-preview');
        canvases.forEach(canvas => {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            };
            
            img.onerror = function() {
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ì´ë¯¸ì§€ ì—†ìŒ', canvas.width/2, canvas.height/2);
            };
            
            img.src = canvas.dataset.src;
        });
    }

    // ë”ë³´ê¸° ê¸°ëŠ¥
    function loadMore(type) {
        console.log('loadMore called with type:', type); // ë””ë²„ê¹…ìš©
        console.log('Current indices - Original:', currentOriginalIndex, 'Webp:', currentWebpIndex); // ë””ë²„ê¹…ìš©
        
        const container = type === 'original' ? 
            document.querySelector('.col-md-6:first-child .row') :
            document.querySelector('.col-md-6:last-child .row');
        
        if (!container) {
            console.error('Container not found'); // ë””ë²„ê¹…ìš©
            return;
        }

        if (type === 'original') {
            const nextFiles = fileList.slice(currentOriginalIndex, currentOriginalIndex + increment);
            console.log('Next original files:', nextFiles); // ë””ë²„ê¹…ìš©
            
            nextFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'col-md-6 mb-4';
                div.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <canvas class="img-preview mb-3" width="200" height="200" 
                                    data-src="/static/images/${url_s}/${file.name}"></canvas>
                            <h6 class="card-title text-truncate">${file.name}</h6>
                            <p class="card-text">
                                <small class="text-muted">í¬ê¸°: ${file.size} bytes</small><br>
                                <span class="badge bg-${file.name.includes('ico') ? 'success' : 
                                    file.name.includes('logo') ? 'primary' : 'secondary'}">
                                    ${file.name.includes('ico') ? 'ì•„ì´ì½˜' : 
                                    file.name.includes('logo') ? 'ë¡œê³ ' : 'ê¸°íƒ€'}
                                </span>
                            </p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            currentOriginalIndex += increment;
            
            if (currentOriginalIndex >= fileList.length) {
                const button = document.querySelector('.col-md-6:first-child .btn-outline-primary');
                if (button) button.style.display = 'none';
            }
        } else {
            const allWebpFiles = {{ convertedfiles | tojson | safe }};
            
            const filesToShow = allWebpFiles.slice(currentWebpIndex, currentWebpIndex + increment);
            console.log('Files to show:', filesToShow); // ë””ë²„ê¹…ìš©
            
            filesToShow.forEach(convertedfile => {
                const div = document.createElement('div');
                div.className = 'col-md-6 mb-4';
                div.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <canvas class="img-preview mb-3" width="100" height="100" 
                                    data-src="/static/images/${url_s}/img_to_webp/${convertedfile.name}"></canvas>
                            <h6 class="card-title text-truncate">${convertedfile.name}</h6>
                            <p class="card-text">
                                <small class="text-muted">í¬ê¸°: ${convertedfile.size} bytes</small>
                                <br>
                                ${convertedfile.original_size ? `
                                <small class="text-success">
                                    ì ˆê°: ${((convertedfile.original_size - convertedfile.size) / convertedfile.original_size * 100).toFixed(1)}%
                                </small>` : ''}
                            </p>
                            <div class="text-end">
                                <button class="btn btn-outline-success btn-sm" onclick="downloadSingleWebp('${url_s}', '${convertedfile.name}')">
                                    <i class="fas fa-download me-1"></i>Webp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            currentWebpIndex += increment;
            
            if (currentWebpIndex >= allWebpFiles.length) {
                const button = document.querySelector('.col-md-6:last-child .btn-outline-primary');
                if (button) button.style.display = 'none';
            }
        }
        
        // ìƒˆë¡œ ì¶”ê°€ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
        setTimeout(loadImagePreviews, 100);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        loadImagePreviews();
        console.log('Initial load complete'); // ë””ë²„ê¹…ìš©
    });

    // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    function downloadImageList() {
        let content = 'ì´ë¯¸ì§€ íŒŒì¼ ëª©ë¡\n\n';
        content += `ì´ ìš©ëŸ‰: ${totalsize}\n\n`;
        fileList.forEach(file => {
            content += `${file.name} ${file.size} bytes\n`;
        });
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'file_list_ecoweb.txt';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function downloadWebpFiles() {
        window.location.href = '/download-webp';
    }
    function downloadSingleWebp(url_s, filename) {
    try {
        // URLì—ì„œ http:// ë˜ëŠ” https:// ì œê±°
        const cleanUrl = url_s.replace(/^https?:\/\//, '');
        const downloadUrl = `/download-single-webp/${cleanUrl}/${filename}`;
        
        console.log('Download URL:', downloadUrl);  // ë””ë²„ê¹…ìš©
        
        fetch(downloadUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.endsWith('.webp') ? filename : `${filename}.webp`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Download error:', error);
                alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    } catch (error) {
            console.error('Function error:', error);
            alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>

{% endblock %}