<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <title>ECO-WEB ê²°ê³¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>

</head>
<body>
    <style>
        body {
            font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        
        .container {
            max-width: 1578px;
        }
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 1rem 0;  /* ì¢Œìš° íŒ¨ë”© ì œê±°, ìƒí•˜ íŒ¨ë”©ë§Œ ìœ ì§€ */
        z-index: 1000;
    }
        .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0;  /* íŒ¨ë”© ì œê±° */
        max-width: 96%;  /* ìµœëŒ€ ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
        margin: 0;  /* ë§ˆì§„ ì œê±° */
    }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding-top: 80px; /* í—¤ë” ë†’ì´ë§Œí¼ ì—¬ë°± */
            z-index: 100;
        }
    
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu i {
        margin-right: 12px;
        font-size: 2.2rem;
        color: #00824c;
    }
        .sidebar-menu li {
            margin: 8px 0;
        }
    
        .sidebar-menu a {
            display: flex;
            font-size: 1.2rem;
            align-items: center;
            padding: 12px 24px;
            color: #1a1a1a;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar-menu a:hover {
            background: #f8f9fa;
            color: #00824c;
        }
    
        .sidebar-menu i {
            margin-right: 12px;
            font-size: 1.2rem;
            color: #00824c;
        }
    
        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ ì¡°ì • */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
    
        .logo-container {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-left: 20px;  /* ë¡œê³ ì—ë§Œ ì™¼ìª½ íŒ¨ë”© ì ìš© */
    }
    
        .logo-leaf {
            color: #00824c;
            font-size: 1.8rem;
        }
    
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00824c;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-leaf {
            color: #00824c;
            font-size: 1.8rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00824c;
            text-decoration: none;
        }

        .auth-buttons {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding-right: 40px;  /* ì˜¤ë¥¸ìª½ ì—¬ë°± ì¶”ê°€ */
    }

        .auth-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: inherit;
            font-size: 0.9rem;
        }
        
    .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-details {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .user-institution,
    .user-department,
    .user-name {
        color: #666;
        font-size: 0.9rem;
    }
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ ì¡°ì • */
        .main-content {
            margin-left: 250px;
            margin-top: 60px; /* í—¤ë” ë†’ì´ë§Œí¼ ì—¬ë°± */
            padding: 20px;
        }
        

        .content-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .analysis-wrapper {
        margin-bottom: 30px;
    }
    .resource-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .resource-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .resource-item h4 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .resource-item p {
        color: #666;
        margin: 5px 0;
        font-size: 1.1rem;
    }

    .optimization-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    .optimization-item {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
    }
    .grade-circle {
    width: 216px;
    height: 216px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 72px;
    color: white;
    flex-shrink: 0;
}

    /* ë“±ê¸‰ë³„ ìƒ‰ìƒ í´ë˜ìŠ¤ */
    .grade-A-plus {
        background-color: #00ffbb;
    }
    .grade-A {
        background-color: #00ff00;
    }
    .grade-B {
        background-color: #ffff00;
    }
    .grade-C {
        background-color: #ffa500;
    }
    .grade-D {
        background-color: #ff6b00;
    }
    .grade-F {
        background-color: #ff0000;
    }
    .result-header {
        display: flex;
        align-items: flex-start;
        gap: 30px;
        margin-top: 59px;
        margin-inline: 24px;
    }
    .result-info {
        flex-grow: 1;
    }
    .result-text {
        font-size: 27px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
    }

    .result-details p {
        font-size: 25px;
        margin: 10px 0;
        color: #444;
        line-height: 1.4;
    }

    .website-url {
        font-size: 16px;
        color: #666;
        margin-bottom: 15px;
    }
    .carbon-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.metric-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.grade-bar {
    position: relative;
    height: 40px;
    background: linear-gradient(to right, 
            #00ffbb,  /* A+ */
            #00ff00,  /* A */
            #ffff00,  /* B */
            #ffa500,  /* C */
            #ff6b00,  /* D */
            #ff0000   /* F */
        );
    border-radius: 20px;
        margin: 20px 0;
    }
    .footer-content {
    /* max-width: 1200px; */
    margin: 0 auto;
    padding: 20px;
    text-align: center;
}


.footer-text {
    margin: 5px 0;
    color: #666;
}


.eco-badge.light {
        background: white;
        border: 1px solid #ddd;
        color: #1e1e1e;
    }

    .badge-section {
        text-align: center;
        background: #f8f9fa;
        padding: 40px 20px;
        border-radius: 12px;
        margin: 40px 0;
    }

    .badge-section h4 {
        color: #333;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .badge-description {
        color: #666;
        margin-bottom: 25px;
        font-size: 1.1em;
    }

    .eco-badge {
        display: inline-flex;
        align-items: center;
        background: #1e1e1e;
        border-radius: 6px;
        padding: 10px 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .eco-badge .carbon-amount {
        background: #00ff9d;
        color: #1e1e1e;
        padding: 6px 12px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.95em;
        letter-spacing: 0.3px;
    }

    .eco-badge .badge-text {
        color: black;
        font-weight: 500;
        margin-left: 12px;
        font-size: 0.95em;
        letter-spacing: 0.5px;
    }

    .badge-subtitle {
        color: #666;
        font-size: 0.9em;
        margin-top: 12px;
        font-weight: 500;
    }

    .get-badge-btn {
        background-color: #00ffbb;
        color: #1e1e1e;
        border: none;
        border-radius: 6px;
        padding: 12px 24px;
        font-weight: 600;
        margin-top: 20px;
        transition: all 0.3s ease;
    }
    .get-badge-btn:hover {
        background-color: #00e6a8;
        transform: translateY(-1px);
    }
    .grade-marker {
        position: absolute;
        top: 0px;
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: left 0.5s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .earth-icon {
        position: absolute;
        top: -2px;
        left: 60%;
        font-size: 31px;
    }
    .global-average {
        position: absolute;
        top: -24px;
        left: 63%;
        color: 4cc2a5;
    }
    .metric-icon { 
        font-size: 50px;
    }
    .col-md-6 {
        /* padding: 0 15px; */
        /* width: 500px; */
    }
    .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;  /* ë‘ ê°œì˜ ë™ì¼í•œ ë„ˆë¹„ì˜ ì—´ */
    gap: 5px;  /* ê·¸ë¦¬ë“œ ì•„ì´í…œ ì‚¬ì´ì˜ ê°„ê²© */
    margin-bottom: 30px;
}

.chart-item {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);

}

/* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒì„ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
@media (max-width: 1200px) {
    .charts-grid {
        grid-template-columns: 1fr;  /* í™”ë©´ì´ ì‘ì•„ì§€ë©´ í•œ ì—´ë¡œ ë³€ê²½ */
    }
}

/* ê·¸ë˜í”„ í¬ê¸° ì¡°ì •ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
#resource-donut, #histogram {
    width: 700px;
    height: 100%;
}

    </style>
    
    <!-- í—¤ë” ìˆ˜ì • -->
    <header>
        <div class="header-content">
            <div class="logo-container">
                <i class="fas fa-leaf logo-leaf"></i>
                <a href="/" class="logo">ECO-WEB</a>
            </div>
            <div class="auth-buttons">
                {% if session.get('username') %}
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-institution">{{ session.get('institution') }}</span>
                        <span class="user-department">{{ session.get('department') }} ë¶€ì„œ</span>
                        <span class="user-name">{{ session.get('username') }} ë‹˜</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="auth-btn logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        ë¡œê·¸ì•„ì›ƒ
                    </a>
                </div>
                {% else %}
                <a href="{{ url_for('login') }}" class="auth-btn login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    ë¡œê·¸ì¸
                </a>
                <a href="{{ url_for('signup') }}" class="auth-btn signup-btn">
                    <i class="fas fa-user-plus"></i>
                    íšŒì›ê°€ì…
                </a>
                {% endif %}
            </div>
        </div>
    </header>
    
    <!-- ì‚¬ì´ë“œë°” ì¶”ê°€ -->
    <nav class="sidebar">
        <ul class="sidebar-menu">
            <li>
                <a href="#carbon-emission">
                    <i class="fas fa-leaf"></i>
                    íƒ„ì†Œë°°ì¶œëŸ‰
                </a>
            </li>
            <li>
                <a href="#statistics">
                    <i class="fas fa-chart-bar"></i>
                    ê³µê³µê¸°ê´€ í†µê³„ í˜„í™©
                    
                </a>
            </li>
            <li>
                <a href="#ai-solution">
                    <i class="fas fa-robot"></i>
                    AI ì†”ë£¨ì…˜
                </a>
            </li>
            <li>
                <a href="#mypage">
                    <i class="fas fa-user"></i>
                    ë§ˆì´í˜ì´ì§€
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  ë˜í¼ -->
<div class="main-content">
    <div class="container">
        <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
        <div class="content-card">
            <div class="analysis-wrapper" style="display: flex; gap: 30px;">
                <!-- ì™¼ìª½: ì›¹ì‚¬ì´íŠ¸ ë¶„ì„ ê²°ê³¼ -->
                <div class="website-analysis" style="flex: 1; margin-inline:11px;">
                    <h3 style="font-weight: bold;">ì›¹ì‚¬ì´íŠ¸ ë¶„ì„ ê²°ê³¼</h3>
                    <p class="website-url">ì¸¡ì •í•œ ì›¹ì‚¬ì´íŠ¸: {{url}}</p>
                    <div class="result-header">
                        <div class="grade-circle grade-{{ grade }}">{{ grade }}</div>
                        <div class="result-info">
                            <p class="result-text">í•´ë‹¹ ì›¹í˜ì´ì§€ëŠ” íƒ„ì†Œ ë°°ì¶œ {{grade}} ë“±ê¸‰ì…ë‹ˆë‹¤.</p>
                            <div class="result-details">
                                <p>ì „ ì„¸ê³„ í‰ê· ë³´ë‹¤ {{global_avg_diff}}MB ë” ë°°ì¶œ</p>
                                <p>ëŒ€í•œë¯¼êµ­ í‰ê· ë³´ë‹¤ {{korea_avg_diff|abs}}MB {% if korea_avg_diff > 0 %}ë”{% else %}ëœ{% endif %} ë°°ì¶œ</p>
                                <p>ë©”ì¸í˜ì´ì§€ ìš©ëŸ‰: {{(kb_weight/1024)|round(2)}}MB</p>
                                <p>íƒ„ì†Œ ë°°ì¶œëŸ‰: {{carbon_emission}}g</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- ë“±ê¸‰ ë°” -->
            <div class="grade-bar">
                <span class="global-average">ì „ ì„¸ê³„ í‰ê· </span>
                <span class="earth-icon">ğŸŒ</span>
                <span class="grade-marker" style="left: 95%; color: rgb(255, 0, 0); transform: translateX(-80%);">{{grade}}</span>
            </div>
            
            <p style="font-size: 16px;">ë§ˆì§€ë§‰ ì¸¡ì •ì¼: 2024-10-11 <a href="/" style="color: white;">ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°</a></p>
        </div>

        <div class="content-card" >
            <h3 style="font-weight: bold;">ì—°ê°„ íƒ„ì†Œ ë°°ì¶œëŸ‰ í™˜ì‚°</h3>
            <p class="metrics-subtitle">ì›” 10,000ëª… ë°©ë¬¸ ê¸°ì¤€ ({{carbon_emission / 1000 * 10000 * 12}} COâ‚‚/kg)</p>
            
            <div class="carbon-metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">â˜•</div>
                    <div class="metric-content">
                        <h4>ì»¤í”¼ ë“ì´ëŠ” ì”ì˜ ìˆ˜</h4>
                        <p class="metric-value">{{(carbon_emission /1000 * 10000 * 12 / 0.01)|round}}ì”</p>
                        <p class="metric-desc">ì»¤í”¼ 1ì” = 0.01g COâ‚‚</p>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">ğŸš—</div>
                    <div class="metric-content">
                        <h4>ì „ê¸°ì°¨ ì£¼í–‰ê±°ë¦¬</h4>
                        <p class="metric-value">{{(carbon_emission/1000 * 10000 * 12 / 0.16 * 2)|round}}km</p>
                        <p class="metric-desc">2km ì£¼í–‰ = 0.16kg COâ‚‚</p>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">ğŸ“±</div>
                    <div class="metric-content">
                        <h4>ìŠ¤ë§ˆíŠ¸í° ì¶©ì „</h4>
                        <p class="metric-value">{{(carbon_emission/1000 * 10000 * 12 / 0.02 * 3)|round}}íšŒ</p>
                        <p class="metric-desc">3íšŒ ì¶©ì „ = 0.02g COâ‚‚</p>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">ğŸŒ³</div>
                    <div class="metric-content">
                        <h4>ë‚˜ë¬´ í¡ìˆ˜ëŸ‰</h4>
                        <p class="metric-value">{{(carbon_emission/1000 * 10000 * 12 / 0.02)|round}}ê·¸ë£¨</p>
                        <p class="metric-desc">1ê·¸ë£¨ = 0.02kg COâ‚‚/ë…„</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="content-card">
                <!-- ì´ê³³ì— íƒ„ì†Œ ë°°ì¶œëŸ‰ ë¶„í¬ ë™ê·¸ë€ ê·¸ë˜í”„ ì¶”ê°€ -->
                <div class="charts-grid">
                    <!-- ë¦¬ì†ŒìŠ¤ íƒ€ì…ë³„ ë„ë„› ì°¨íŠ¸ -->
                    <div class="chart-item">
                        <h3 style="font-weight: bold;">ë¦¬ì†ŒìŠ¤ íƒ€ì…ë³„ ìš©ëŸ‰ ë¶„í¬</h3>
                        <div id="resource-donut"></div>
                    </div>
            
                    <!-- ì „ì²´ ì •ë¶€/ê³µê¸°ê´€ íƒ„ì†Œ ë°°ì¶œëŸ‰ ë¶„í¬ -->
                    <div class="chart-item">
                        <h3 style="font-weight: bold;">ì „ì²´ ì •ë¶€/ê³µê¸°ê´€ íƒ„ì†Œ ë°°ì¶œëŸ‰ ë¶„í¬</h3>
                        <svg id="histogram" width="800" height="300"></svg>
                    </div>
                </div>

                <div class="distribution-chart">
                    <h4>í˜„ì¬ ì¸¡ì •ëœ ì›¹ì‚¬ì´íŠ¸ íŠ¸ë˜í”½ ë¶„í¬ (ì•½ 7300ê°œ,kde)</h4>
                    <div id="kde-plot"></div>
                </div>

                <div class="institution-chart-container">
                    <h4>ê¸°ê´€ë³„ ì›¹ì‚¬ì´íŠ¸ ì „ì†¡ í¬ê¸° ë¶„í¬</h4>
                    <div id="institution-chart" width="1500" height="500"></div>
                </div>

                <!-- ìƒˆë¡œìš´ ë©€í‹°ë¼ì¸ ê·¸ë˜í”„ ì¶”ê°€ -->
                <div class="mt-5">
                    <h4>ì‹¤ì‹œê°„ íƒ„ì†Œë°°ì¶œëŸ‰ ì¶”ì´ (google analytics API ì…ë ¥ í•„ìš”)</h4>
                    <svg id="multiline" width="1500" height="500"></svg>
                </div>
        </div>

        <style>
            /* í”„ë¡œê·¸ë˜ìŠ¤ ë°” ìŠ¤íƒ€ì¼ */
        .progress-container {
            width: 200px;
            height: 200px;
            margin: 20px auto; /* ìƒí•˜ 20px ê°„ê²©, ì¢Œìš° ì¤‘ì•™ ì •ë ¬ */
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            align-items: center;
            justify-content: center;
            position: relative; /* ìœ„ì¹˜ ì¡°ì •ì„ ìœ„í•´ relative ì„¤ì • */
        }

        .spinner {
            width: 150px;
            height: 150px;
            border: 16px solid rgba(144, 238, 144, 0.3); /* íŒŒìŠ¤í…” ì´ˆë¡ìƒ‰ íˆ¬ëª…í•œ í…Œë‘ë¦¬ */
            border-top: 16px solid rgba(144, 238, 144, 1); /* íŒŒìŠ¤í…” ì´ˆë¡ìƒ‰ ë¶ˆíˆ¬ëª… í…Œë‘ë¦¬ */
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            z-index: 1; /* í”„ë¡œê·¸ë˜ìŠ¤ ë°” ìœ„ì— í‘œì‹œ */
            border-radius: 50%; /* ì˜¤ë²„ë ˆì´ë¥¼ ì›í˜•ìœ¼ë¡œ */
        }
        </style>
        <!-- ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ í˜„í™© ì¹´ë“œ -->
        <div class="content-card">
            <!-- ì§€ì†ê°€ëŠ¥í•œ ì›¹ê°œë°œ ê°€ì´ë“œë¼ì¸ -->
            <section class="mt-5">
                <h4 style="margin-left: 31px;">W3c ì§€ì†ê°€ëŠ¥í•œ ì›¹ê°œë°œ ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ í˜„í™© (llama3.2 RAG ëª¨ë¸ ì‚¬ìš©)</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">ë²ˆí˜¸</th>
                            <th scope="col">í•­ëª©</th>
                            <th scope="col">ì¤€ìˆ˜ì—¬ë¶€</th>
                        </tr>
                    </thead>
                    <tbody id="guideline-section">
                    </tbody>
                </table>
            </section>

            <div id="progress-overlay"></div>
            <div id="progress-bar" class="progress-container">
                <div class="spinner"></div>
            </div>

            <script>
                const taskId = "{{ task_id }}";

                // ë¹„ë™ê¸° ì‘ì—… ê²°ê³¼ë¥¼ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
                function checkAsyncResult() {
                    fetch(`/check_async/${taskId}`)
                        .then(response => {
                            if (response.status === 200) {
                                return response.json();
                            } else if (response.status === 202) {
                                return { status: 'pending' };
                            } else {
                                throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ');
                            }
                        })
                        .then(data => {
                            if (data.status === 'completed') {
                                const guideline = document.getElementById('guideline-section');

                                // ê¸°ì¡´ì˜ "ë¹„ë™ê¸° ì‘ì—… ì§„í–‰ ì¤‘..." ë©”ì‹œì§€ë¥¼ ì œê±°
                                guideline.innerHTML = '';

                                // ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ìŠ¤ ë°”ì™€ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                                document.getElementById('progress-overlay').style.display = 'none';
                                document.getElementById('progress-bar').style.display = 'none';

                                // data.resultëŠ” [{number: , title: , isFellow: }, {}, ..., {}] í˜•íƒœì˜ 12ê°œ ê°ì²´ ë°°ì—´
                                data.result.forEach(item => {
                                    // ìƒˆë¡œìš´ í…Œì´ë¸” í–‰ ìƒì„±
                                    const tr = document.createElement('tr');

                                    // Number ì—´ ìƒì„± ë° ê°’ ì„¤ì •
                                    const tdNumber = document.createElement('td');
                                    tdNumber.textContent = item.number;
                                    tr.appendChild(tdNumber);

                                    // Title ì—´ ìƒì„± ë° ê°’ ì„¤ì •
                                    const tdTitle = document.createElement('td');
                                    tdTitle.textContent = item.title;
                                    tr.appendChild(tdTitle);

                                    // isFellow ì—´ ìƒì„± ë° ì¡°ê±´ì— ë”°ë¼ âœ… ë˜ëŠ” âŒ ì„¤ì •
                                    const tdIsFellow = document.createElement('td');
                                    tdIsFellow.textContent = item.isFellow === "True" ? "âœ…" : "âŒ";
                                    tr.appendChild(tdIsFellow);

                                    // ìƒì„±ëœ í–‰ì„ tbodyì— ì¶”ê°€
                                    guideline.appendChild(tr);
                                });

                                clearInterval(intervalId);  // í´ë§ ì¤‘ì§€
                            } else {
                                console.log('ë¹„ë™ê¸° ì‘ì—… ì§„í–‰ ì¤‘...');
                            }
                        })
                        .catch(error => {
                            console.error('ì˜¤ë¥˜:', error);
                        });
                }

                // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¹„ë™ê¸° ì‘ì—… ìƒíƒœ í™•ì¸ ì‹œì‘
                window.onload = function() {
                    document.getElementById('progress-overlay').style.display = 'block';
                    document.getElementById('progress-bar').style.display = 'flex';
                    // 5ì´ˆë§ˆë‹¤ ë¹„ë™ê¸° ì‘ì—… ìƒíƒœ í™•ì¸
                    window.intervalId = setInterval(checkAsyncResult, 5000);
                };
        </script>

        <!-- ìµœì í™” ì œì•ˆ ì¹´ë“œ -->
        <div class="content-card">
            <h3 style="margin-left: 11px;">ìµœì í™” ê°€ëŠ¥ í•­ëª©</h3>
            <!-- Google Lighthouse ìƒì„¸ ë³´ê³ ì„œ -->
            <div class="container mt-5" style="font-size: 21px;">
                <h4>Google Lighthouse ìƒì„¸ ë¶„ì„ ê²°ê³¼</h4>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="thead-light">
                <tr>
                    <th>ë¶„ì„ í•­ëª©</th>
                    <th>ìš©ëŸ‰</th>
                    <th>ìƒì„¸ ë‚´ìš©</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ì´ ë¦¬ì†ŒìŠ¤ ìš©ëŸ‰</td>
                    <td>{{ (view_data.total_byte_weight / 1024 / 1024)|round(2) }}MB</td>
                    <td>ì „ì²´ í˜ì´ì§€ ë¦¬ì†ŒìŠ¤ í¬ê¸°</td>
                </tr>
                <tr>
                    <td>ì„œë“œíŒŒí‹° ìŠ¤í¬ë¦½íŠ¸ ì œê±°</td>
                    <td>{{ (view_data.third_party_summary_wasted_bytes / 1024 / 1024)|round(2) }}MB</td>
                    <td>ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì¸í•œ ë‚­ë¹„ ìš©ëŸ‰</td>
                </tr>
                <tr>
                    <td>JavaScript ë¶„ì„</td>
                    <td>
                        ë¯¸ì‚¬ìš©: {{ (view_data.total_unused_bytes_script / 1024 / 1024)|round(2) }}MB<br>
                        ì „ì²´: {{ (view_data.total_resource_bytes_script / 1024 / 1024)|round(2) }}MB
                    </td>
                    <td>ì „ì²´ JavaScript ì¤‘ ë¯¸ì‚¬ìš© ì½”ë“œ ë¹„ìœ¨:
                        {{ ((view_data.total_unused_bytes_script / view_data.total_resource_bytes_script) * 100)|round(1) }}%
                    </td>
                </tr>
                {% if view_data.can_optimize_css_bytes > 0 %}
                <tr>
                    <td>ë¯¸ì‚¬ìš© CSS</td>
                    <td>{{ (view_data.can_optimize_css_bytes / 1024)|round(2) }}KB</td>
                    <td>ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” CSS ê·œì¹™ ì œê±°ë¡œ ìµœì í™” ê°€ëŠ¥</td>
                </tr>
                {% endif %}
                {% if view_data.can_optimize_js_bytes > 0 %}
                <tr>
                    <td>ë¯¸ì‚¬ìš© JavaScript</td>
                    <td>{{ (view_data.can_optimize_js_bytes / 1024)|round(2) }}KB</td>
                    <td>ì§€ì—° ë¡œë”© ë° ë¯¸ì‚¬ìš© ì½”ë“œ ì œê±°ë¡œ ìµœì í™” ê°€ëŠ¥</td>
                </tr>
                {% endif %}
                {% if view_data.modern_image_formats_bytes > 0 %}
                <tr>
                    <td>ì´ë¯¸ì§€ ìµœì í™” ê°€ëŠ¥</td>
                    <td>{{ (view_data.modern_image_formats_bytes / 1024)|round(2) }}KB</td>
                    <td>WebP/AVIF í¬ë§· ë³€í™˜ìœ¼ë¡œ ì ˆê° ê°€ëŠ¥</td>
                </tr>
                {% endif %}
                {% if view_data.efficient_animated_content > 0 %}
                <tr>
                    <td>ì• ë‹ˆë©”ì´ì…˜ ìµœì í™”</td>
                    <td>{{ (view_data.efficient_animated_content / 1024)|round(2) }}KB</td>
                    <td>GIFë¥¼ MP4/WebMìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì ˆê° ê°€ëŠ¥</td>
                </tr>
                {% endif %}
                {% if view_data.duplicated_javascript > 0 %}
                <tr>
                    <td>ì¤‘ë³µ JavaScript</td>
                    <td>{{ (view_data.duplicated_javascript / 1024)|round(2) }}KB</td>
                    <td>ì¤‘ë³µëœ JavaScript ëª¨ë“ˆ ì œê±°ë¡œ ìµœì í™” ê°€ëŠ¥</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- ì´ ìµœì í™” ê°€ëŠ¥ ìš©ëŸ‰ ê³„ì‚° ë° í‘œì‹œ -->
    {% set total_optimization = view_data.can_optimize_css_bytes +
        view_data.can_optimize_js_bytes +
        view_data.modern_image_formats_bytes +
        view_data.efficient_animated_content +
        view_data.duplicated_javascript %}
{% if total_optimization > 0 %}
<div class="alert alert-info mt-3">
<strong>ì´ ìµœì í™” ê°€ëŠ¥ ìš©ëŸ‰:</strong>
{{ (total_optimization / 1024 / 1024)|round(2) }}MB
(í˜„ì¬ ìš©ëŸ‰ì˜ {{ ((total_optimization / view_data.total_byte_weight) * 100)|round(1) }}%)
</div>
{% endif %}
</div>



<div class="content-card">
    <h3>ìµœì í™” ì „/í›„ ë¹„êµ</h3>
    <div class="row">
        <div class="col-md-6">
                            <h5>Before</h5>
                            <img src="../static/screenshots/before.png" alt="Before" class="comparison-image" style="width: 87%;">
                            <h2>ì´ ë¦¬ì†ŒìŠ¤: {{(view_data.total_byte_weight/1024/1024)|round(2)}}MB</h2>
                        </div>
                        <div class="col-md-6">
            <h5>After</h5>
            <img src="../static/screenshots/before.png" alt="Before" class="comparison-image" style="width: 87%;">
            <h2>ì ˆê° í›„ ë¦¬ì†ŒìŠ¤: {{((view_data.total_byte_weight - total_optimization)/1024/1024)|round(2)}}MB</h2>
        </div>
    </div>
</div>
{% set optimization_carbon = total_optimization/1024 /68 * 0.01 %}                
<div class="text-center mt-4">
                    <h2>{{(total_optimization/1024/1024)|round(2)}}MBì€ ì›” 1ë§ŒíšŒì˜ ë°©ë¬¸ìì¼ ë•Œ, </h2>
                    <div class="content-card" >
                        <h3 style="font-weight: bold;">ì—°ê°„ íƒ„ì†Œ ë°°ì¶œëŸ‰ í™˜ì‚°</h3>
                        <p class="metrics-subtitle">ì›” 10,000ëª… ë°©ë¬¸ ê¸°ì¤€ ({{ optimization_carbon/1000 * 10000 * 12|round}} COâ‚‚/kg)</p>
                        
                        <div class="carbon-metrics-grid">
                            <div class="metric-card">
                                <div class="metric-icon">â˜•</div>
                                <div class="metric-content">
                                    <h4>ì»¤í”¼ ë“ì´ëŠ” ì”ì˜ ìˆ˜</h4>
                                    <p class="metric-value">{{( optimization_carbon/1000 * 10000 * 12 / 0.01)|round}}ì”</p>
                                    <p class="metric-desc">ì»¤í”¼ 1ì” = 0.01g COâ‚‚</p>
                                </div>
                            </div>
            
                            <div class="metric-card">
                                <div class="metric-icon">ğŸš—</div>
                                <div class="metric-content">
                                    <h4>ì „ê¸°ì°¨ ì£¼í–‰ê±°ë¦¬</h4>
                                    <p class="metric-value">{{( optimization_carbon/1000 * 10000 * 12 / 0.16 * 2)|round}}km</p>
                                    <p class="metric-desc">2km ì£¼í–‰ = 0.16kg COâ‚‚</p>
                                </div>
                            </div>
            
                            <div class="metric-card">
                                <div class="metric-icon">ğŸ“±</div>
                                <div class="metric-content">
                                    <h4>ìŠ¤ë§ˆíŠ¸í° ì¶©ì „</h4>
                                    <p class="metric-value">{{( optimization_carbon/1000 * 10000 * 12 / 0.02 * 3)|round}}íšŒ</p>
                                    <p class="metric-desc">3íšŒ ì¶©ì „ = 0.02g COâ‚‚</p>
                                </div>
                            </div>
            
                            <div class="metric-card">
                                <div class="metric-icon">ğŸŒ³</div>
                                <div class="metric-content">
                                    <h4>ë‚˜ë¬´ í¡ìˆ˜ëŸ‰</h4>
                                    <p class="metric-value">{{( optimization_carbon/1000 * 10000 * 12 / 0.02)|round}}ê·¸ë£¨</p>
                                    <p class="metric-desc">1ê·¸ë£¨ = 0.02kg COâ‚‚/ë…„</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="/" class="btn btn-secondary">ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°</a>
                </div>
            </div>
        </div>
    </div>
    <div class="content-card">
        <div class="badge-section">
            <h2>íƒ„ì†Œ ë°°ì¶œ ì¦ëª… ë°°ì§€</h2>
            <p class="badge-description">
                <h5>ë°°ì§€ëŠ” ì›¹ì‚¬ì´íŠ¸ í—¤ë”ë‚˜ í‘¸í„°ì— ì¶”ê°€í•˜ì—¬ ê° í˜ì´ì§€ì˜ íƒ„ì†Œ ë°°ì¶œëŸ‰ì„ ìë™ìœ¼ë¡œ ê³„ì‚°í•˜ê³  í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</h5>
            </p>
        
            <div class="eco-badge light">
                <span class="carbon-amount">{{carbon_emission}}g of CO2/view</span>
                <span class="badge-text">Eco-Web</span>
            </div>
        
            <div class="mt-4">
                <h4>ì˜¤í”ˆ ì†ŒìŠ¤ API</h5>
                <p>
                    <h5>ì›¹ì‚¬ì´íŠ¸ íƒ„ì†Œ ê³„ì‚°ì„ ë‹¤ë¥¸ ë„êµ¬ì™€ ì›Œí¬í”Œë¡œìš°ì— í†µí•©í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì›¹ì‚¬ì´íŠ¸ íƒ„ì†Œ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤!</h5>
                </p>
            </div>
        
            <a href="/badge" class="btn get-badge-btn">
                ë°°ì§€ ì„¤ì¹˜í•˜ê¸°
            </a>
                </div>
            </div>
        </div>
    <footer>
        <div class="footer-content">
            <p class="footer-text">ECO-WEB, DONGA-UNIVERSITY</p>
            <p class="footer-text">Address: 37, Nakdong-daero 550beon-gil, Saha-gu, Busan, Republic of Korea.</p>
            <p class="footer-text">Tel: 010-8477-6339</p>
            <p class="footer-text">E-mail: qudtnrh@gmail.com</p>
        </div>
    </footer>

    <script>
        // ë“±ê¸‰ì— ë”°ë¥¸ ìœ„ì¹˜ ì„¤ì •
        const grade = "{{ grade }}";
        const gradeMarker = document.querySelector('.grade-marker');

        // ë“±ê¸‰ë³„ ìœ„ì¹˜ ë§¤í•‘ (ì™¼ìª½ë¶€í„° ì˜¤ë¥¸ìª½ìœ¼ë¡œ)
        const gradePositions = {
            'A+': '0%',
            'A': '20%',
            'B': '40%',
            'C': '60%',
            'D': '80%',
            'F': '95%'  // ì™„ì „íˆ ì˜¤ë¥¸ìª½ ë
        };

        // ë“±ê¸‰ë³„ ìƒ‰ìƒ ë§¤í•‘
        const gradeColors = {
            'A+': '#00ffbb',
            'A': '#00ff00',
            'B': '#ffff00',
            'C': '#ffa500',
            'D': '#ff6b00',
            'F': '#ff0000'
        };

        // ë§ˆì»¤ ìœ„ì¹˜ì™€ ìƒ‰ìƒ ì„¤ì •
        if (gradeMarker) {
            gradeMarker.style.left = gradePositions[grade];
            gradeMarker.style.color = gradeColors[grade];

            // ë§ˆì»¤ê°€ ì–‘ ëì— ìˆì„ ë•Œ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì¡°ì •
            if (grade === 'A+') {
                gradeMarker.style.transform = 'translateX(-20%)';
            } else if (grade === 'F') {
                gradeMarker.style.transform = 'translateX(-80%)';
            } else {
                gradeMarker.style.transform = 'translateX(-50%)';
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
    const gradeCircle = document.querySelector('.grade-circle');
    const grade = "{{ grade }}";

    // ë“±ê¸‰ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
    if (grade === 'A+') {
        gradeCircle.classList.add('grade-A-plus');
    } else {
        gradeCircle.classList.add(`grade-${grade}`);
    }
});
    // ì˜ˆì‹œ ë°ì´í„° ìƒì„± (íŒŒì´ì¬ì—ì„œ ë§Œë“  ë°ì´í„°ì™€ ìœ ì‚¬í•˜ê²Œ)
    const existingData = Array.from({length: 25000}, () => d3.randomNormal(0.7,0.05)()); // 0.3ì€ í‰ê· , 0.3ì€ í‘œì¤€í¸ì°¨

    // ìƒˆë¡œìš´ URL ë°ì´í„°
    const newUrlData = 0.65;

    // SVG í¬ê¸° ì„¤ì •
    const svg = d3.select("svg");
    const margin = {top: 20, right: 20, bottom: 30, left: 40};
    const width = +svg.attr("width") - margin.left - margin.right;
    const height = +svg.attr("height") - margin.top - margin.bottom;
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    // Xì¶• ë° Yì¶• ë²”ìœ„ ì„¤ì •
    const x = d3.scaleLinear()
        .domain([d3.min(existingData), d3.max(existingData)])
        .rangeRound([0, width]);

    const bins = d3.histogram()
        .domain(x.domain())
        .thresholds(x.ticks(50))
        (existingData);

    const y = d3.scaleLinear()
        .domain([0, d3.max(bins, d => d.length)])
        .range([height, 0]);

    // Xì¶•
    g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

    // Yì¶•
    g.append("g")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(y));

    // íˆìŠ¤í† ê·¸ë¨ ë§‰ëŒ€ ì¶”ê°€
    g.selectAll(".bar")
        .data(bins)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.x0))
        .attr("y", d => y(d.length))
        .attr("width", d => x(d.x1) - x(d.x0) - 1)
        .attr("height", d => height - y(d.length))
        .attr("fill", "#2349bd"); // íŒŒë€ìƒ‰

    // ìƒˆë¡œìš´ URL ë°ì´í„°ë¥¼ ì„ ìœ¼ë¡œ í‘œì‹œ
    g.append("line")
        .attr("x1", x(newUrlData))
        .attr("x2", x(newUrlData))
        .attr("y1", 0)
        .attr("y2", height)
        .attr("stroke", "red")
        .attr("stroke-width", 2)
        .attr("stroke-dasharray", "4,4");


    // ë©€í‹°ë¼ì¸ ê·¸ë˜í”„ ìƒì„±
    const multilineSvg = d3.select("#multiline");
    const multilineMargin = {top: 40, right: 80, bottom: 50, left: 60};
    const multilineWidth = +multilineSvg.attr("width") - multilineMargin.left - multilineMargin.right;
    const multilineHeight = +multilineSvg.attr("height") - multilineMargin.top - multilineMargin.bottom;

    const multilineG = multilineSvg.append("g")
        .attr("transform", `translate(${multilineMargin.left},${multilineMargin.top})`);

    // 24ì‹œê°„ ë°ì´í„° ìƒì„±
    const hours = Array.from({length: 24}, (_, i) => i);
    const generateHourlyData = () => {
        return hours.map(hour => {
            // ì‹œê°„ëŒ€ë³„ ê°€ì¤‘ì¹˜ ì„¤ì •
            let weight = 1;
            if (hour >= 9 && hour <= 18) {  // ì—…ë¬´ ì‹œê°„
                weight = 1.5 + Math.random() * 0.5;
            } else if (hour >= 1 && hour <= 5) {  // ìƒˆë²½
                weight = 0.3 + Math.random() * 0.2;
            }
            return Math.random() * weight;
        });
    };

    const carbonLevels = generateHourlyData();
    const avgLevels = generateHourlyData().map(v => v * 0.8);  // í‰ê· ì€ ì•½ê°„ ë‚®ê²Œ
    const lowCarbonAvg = generateHourlyData().map(v => v * 0.5);  // ì €íƒ„ì†ŒëŠ” ë” ë‚®ê²Œ

    // ê°€ìƒì˜ ë°ì´í„° ìƒì„± (ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´ í•„ìš”)
    const institutions = Array.from({length: 100}, (_, i) => i);
    const guidelineCount = institutions.map(() => 0.67); //
    const highlightIndex = 42; // í˜„ì¬ ë¶„ì„ ì¤‘ì¸ URLì˜ ì¸ë±ìŠ¤


    // xì¶• ìŠ¤ì¼€ì¼ì„ ì‹œê°„ìœ¼ë¡œ ë³€ê²½
    const multilineX = d3.scaleLinear()
        .domain([0, 23])
        .range([0, multilineWidth]);

    // yì¶• ìŠ¤ì¼€ì¼
    const multilineY = d3.scaleLinear()
        .domain([0, d3.max([...carbonLevels, ...avgLevels, ...lowCarbonAvg]) * 1.2])
        .range([multilineHeight, 0]);

        // xì¶• ëˆˆê¸ˆì„ ì‹œê°„ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
multilineG.append("g")
    .attr("transform", `translate(0,${multilineHeight})`)
    .call(d3.axisBottom(multilineX)
        .ticks(24)
        .tickFormat(d => `${d}ì‹œ`))
    .append("text")
    .attr("x", multilineWidth / 2)
    .attr("y", 40)
        .attr("fill", "black")
        .text("ì‹œê°„");

    // ë¼ì¸ ìƒì„±ê¸°
    const line = d3.line()
        .x((d, i) => multilineX(i))
        .y(d => multilineY(d))
        .curve(d3.curveNatural);

    // ê° ë¼ì¸ ê·¸ë¦¬ê¸°
    multilineG.append("path")
        .datum(carbonLevels)
        .attr("class", "line")
        .style("stroke", "#ff0000")
        .style("fill", "none")
        .style("stroke-width", 2)
        .attr("d", line);

    multilineG.append("path")
        .datum(guidelineCount)
        .attr("class", "line")
        .style("stroke", "#0000ff")
        .style("fill", "none")
        .style("stroke-width", 2)
        .attr("d", line);

    multilineG.append("path")
        .datum(lowCarbonAvg)
        .attr("class", "line")
        .style("stroke", "#00ff00")
        .style("fill", "none")
        .style("stroke-width", 2)
        .attr("d", line);

    // í•˜ì´ë¼ì´íŠ¸ í¬ì¸íŠ¸
    multilineG.append("circle")
        .attr("cx", multilineX(highlightIndex))
        .attr("cy", multilineY(carbonLevels[highlightIndex]))
        .attr("r", 6)
        .style("fill", "#037747");

    // ì¶• ì¶”ê°€
    multilineG.append("g")
        .attr("transform", `translate(0,${multilineHeight})`)
        .call(d3.axisBottom(multilineX).ticks(10))
        .append("text")
        .attr("x", multilineWidth / 2)
        .attr("y", 40)
        .attr("fill", "black")
        .text("ê³µê³µê¸°ê´€");

    multilineG.append("g")
        .call(d3.axisLeft(multilineY))
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -50)
        .attr("x", -multilineHeight / 2)
        .attr("fill", "black")
        .attr("text-anchor", "middle")
        .text("íƒ„ì†Œë°°ì¶œëŸ‰");

    // ë²”ë¡€ ì¶”ê°€
    const legend = multilineG.append("g")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("text-anchor", "start")
        .attr("transform", `translate(${multilineWidth + 10},0)`);

    // ë²”ë¡€ í…ìŠ¤íŠ¸ ìˆ˜ì •
    const legendItems = [
        {color: "#ff0000", text: "í˜„ì¬ ì‚¬ì´íŠ¸"},
        {color: "#0000ff", text: "ê³µê³µê¸°ê´€ í‰ê· "},
        {color: "#00ff00", text: "ì €íƒ„ì†Œ ì‚¬ì´íŠ¸ í‰ê· "}
    ];

    legendItems.forEach((item, i) => {
        const legendRow = legend.append("g")
            .attr("transform", `translate(0,${i * 20})`);

        legendRow.append("rect")
            .attr("width", 15)
            .attr("height", 2)
            .attr("fill", item.color);

        legendRow.append("text")
            .attr("x", 20)
            .attr("y", 5)
            .text(item.text);
    });

    // D3.jsë¡œ KDE ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    async function drawKDEPlot(kb_weight) {
        // JSON ë°ì´í„° ë¡œë“œ
        const current_mb = kb_weight / 1024;

        const data = await d3.json('/static/js/distribution_data.json');

        // ê·¸ë˜í”„ í¬ê¸° ì„¤ì •
        const margin = {top: 40, right: 40, bottom: 40, left: 60};
        const width = 1500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // SVG ìƒì„±
        const svg = d3.select("#kde-plot")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // ìŠ¤ì¼€ì¼ ì„¤ì •
        const x = d3.scaleLinear()
            .domain([0, 20])
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data.kde_points, d => d.y)])
            .range([height, 0]);

        // KDE ê³¡ì„  ê·¸ë¦¬ê¸°
        const line = d3.line()
            .x(d => x(d.x))
            .y(d => y(d.y));

        svg.append("path")
            .datum(data.kde_points)
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("stroke-width", 2)
            .attr("d", line);

        // í•œêµ­ í‰ê· ì„  ê·¸ë¦¬ê¸°
        svg.append("line")
            .attr("x1", x(4.7))
            .attr("x2", x(4.7))
            .attr("y1", 0)
            .attr("y2", height)
            .attr("stroke", "green")
            .attr("stroke-dasharray", "5,5");

            // ì„¸ê³„ í‰ê· ì„  (2.4MB)
        svg.append("line")
            .attr("x1", x(2.4))
            .attr("x2", x(2.4))
            .attr("y1", 0)
            .attr("y2", height)
            .attr("stroke", "blue")
            .attr("stroke-dasharray", "5,5");

        // í˜„ì¬ ì‚¬ì´íŠ¸ ë°°ì¶œëŸ‰
        svg.append("line")
            .attr("x1", x(current_mb))
            .attr("x2", x(current_mb))
            .attr("y1", 0)
            .attr("y2", height)
            .attr("stroke", "red")
            .attr("stroke-width", 2);
        // ì¶• ê·¸ë¦¬ê¸°
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        svg.append("g")
            .call(d3.axisLeft(y));

        // ë²”ë¡€ ì¶”ê°€
        const legendItems = [
                {color: "red", text: "í˜„ì¬ ì‚¬ì´íŠ¸", dash: "0"},
                {color: "green", text: "í•œêµ­ í‰ê·  (4.7MB)", dash: "5,5"},
            {color: "blue", text: "ì„¸ê³„ í‰ê·  (2.4MB)", dash: "5,5"}
        ];


        const legend = svg.append("g")
                .attr("transform", `translate(${width - 150}, 20)`);

            legendItems.forEach((item, i) => {
                const g = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);

                g.append("line")
                    .attr("x1", 0)
                    .attr("x2", 20)
                    .attr("y1", 0)
                    .attr("y2", 0)
                    .attr("stroke", item.color)
                    .attr("stroke-width", 2)
                    .attr("stroke-dasharray", item.dash);

                g.append("text")
                    .attr("x", 25)
                    .attr("y", 5)
                    .text(item.text);
            });
    }

    drawKDEPlot({{kb_weight|round(2)}});

    document.addEventListener('DOMContentLoaded', function() {
            const currentKB = {{kb_weight|round(2)}};
            const currentMB = currentKB / 1024;
            const institutionType = "{{institution_type}}";  // Flaskì—ì„œ ì „ë‹¬ë°›ì€ ê¸°ê´€ íƒ€ì…
            drawInstitutionChart(currentMB, institutionType);
        });
        </script>

    <script src="{{ url_for('static', filename='js/institution_chart.js') }}"></script>


    <!-- ë„ë„› ì°¨íŠ¸ -->
<!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ì— ì•„ë˜ ì½”ë“œ ì¶”ê°€ -->
<script>
    // ë„ë„› ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
    function createDonutChart(data) {
        // ì°¨íŠ¸ í¬ê¸° ì„¤ì •
        const width = 700;
        const height = 300;
        const radius = Math.min(width, height) / 2;
    
        // SVG ìƒì„±
        const svg = d3.select("#resource-donut")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 4},${height / 2})`);  // width/2ë¥¼ width/3ìœ¼ë¡œ ìˆ˜ì •í•˜ì—¬ ì™¼ìª½ìœ¼ë¡œ ì´ë™
    
        // ìƒ‰ìƒ ìŠ¤ì¼€ì¼ ì„¤ì •
        const color = d3.scaleOrdinal()
    .domain(data.map(d => d.name))
    .range([
        '#FF8B5C',  // ì£¼í™©ìƒ‰
        '#9B6B9E',  // ë³´ë¼ìƒ‰
        '#FFD5C2',  // ì‚´êµ¬ìƒ‰
        '#7AC7A3'   // ì—°ë‘ìƒ‰
    ]);
        // íŒŒì´ ìƒì„±ê¸° ì„¤ì •
        const pie = d3.pie()
            .value(d => d.value)
            .sort(null);
    
        // ì•„í¬ ìƒì„±ê¸° ì„¤ì •
        const arc = d3.arc()
            .innerRadius(radius * 0.6) // ë„ë„› ì°¨íŠ¸ì˜ ë‚´ë¶€ ë°˜ì§€ë¦„
            .outerRadius(radius * 0.8); // ë„ë„› ì°¨íŠ¸ì˜ ì™¸ë¶€ ë°˜ì§€ë¦„
    
        // ë°ì´í„° ë°”ì¸ë”© ë° íŒ¨ìŠ¤ ìƒì„±
        const path = svg.selectAll("path")
            .data(pie(data))
            .join("path")
            .attr("d", arc)
            .attr("fill", d => color(d.data.name))
            .attr("stroke", "white")
            .style("stroke-width", "2px");
    
        // ì¤‘ì•™ í…ìŠ¤íŠ¸
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "0em")
            .style("font-size", "29px")
            .text("í˜ì´ì§€ ë¦¬ì†ŒìŠ¤");
    
        // ë²”ë¡€ ìƒì„±
        const legend_donut = svg.append("g")
            .attr("transform", `translate(${radius + 30},-${radius/2})`);
    
        data.forEach((d, i) => {
            const legendRow = legend_donut.append("g")
                .attr("transform", `translate(0, ${i * 25})`);
    
            legendRow.append("rect")
                .attr("width", 18)
                .attr("height", 18)
                .attr("fill", color(d.name));
    
            legendRow.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", "0.35em")
                .text(`${d.name} (${(d.value/1024).toFixed(2)}KB)`);
        });
    }

    // ë„ë„› ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ ë° ìƒì„±
    const resourceData = [
        { name: "í°íŠ¸", value: {{view_data.font_total_bytes}} },
        { name: "ìŠ¤í¬ë¦½íŠ¸", value: {{view_data.script_total_bytes}} },
        { name: "HTML", value: {{view_data.html_total_bytes}} },
        { name: "CSS", value: {{view_data.css_total_bytes}} },
        { name: "ê¸°íƒ€", value: {{view_data.other_total_bytes}} },
        { name: "ë¯¸ë””ì–´", value: {{view_data.media_total_bytes}} },
        { name: "ì„œë“œíŒŒí‹°", value: {{view_data.third_party_total_bytes}} }
    ];
    
    createDonutChart(resourceData);
    </script>
    <!-- /ë„ë„› ì°¨íŠ¸ -->

</body>
</html>